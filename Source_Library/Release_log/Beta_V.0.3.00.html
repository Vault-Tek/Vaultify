<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vaultify - Password Manager (Hardened)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { transform-style: preserve-3d; transition: transform 0.1s ease-out; position: relative;}
    .password-container { max-height: 300px; overflow-y: scroll; scrollbar-width: none; }
    .password-container::-webkit-scrollbar { display: none; }
    .search-container { display: none; margin-top: 10px; }
    .password-container li { background-color: #1F2937; padding: 12px; border-radius: 8px; display: flex; flex-direction: column; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn { background-color: #2d3748; color: #edf2f7; padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; margin: 0 4px; border: none; cursor: pointer; }
    .btn-view,.btn-edit,.btn-delete { background-color: #2d3748; }
    .action-btns { display: flex; justify-content: flex-start; align-items: center; }
    .action-btns button { margin-right: 5px; }
    .no-match-card { background-color: #1F2937; padding: 12px; border-radius: 8px; text-align: center; margin-top: 10px; color: #edf2f7; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .notification { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); background-color: #1F2937; color: #edf2f7; padding: 12px 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 5000; display: none;}
    .error { background-color: #1F2937; }
    .lock-animation { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; font-size: 3rem; animation: lockAnimation 2s infinite; }
    @keyframes lockAnimation { 0% { transform: translate(-50%, -50%) scale(1);} 50% { transform: translate(-50%, -50%) scale(1.2);} 100% { transform: translate(-50%, -50%) scale(1);} }
    .hidden { display: none; }
    .slide-menu { position: fixed; top: 0; left: -300px; width: 300px; height: 100%; background-color: #1F2937; color: #edf2f7; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.5); transition: left 0.3s; z-index: 3000;}
    .slide-menu.open { left: 0; }
    .menu-option { cursor: pointer; padding: 10px; border-radius: 4px; transition: background-color 0.3s; }
    .menu-option:hover { background-color: #2d3748; }
    .menu-toggle { display: none !important; }
    .menu-toggle div { background-color: #edf2f7; height: 4px; border-radius: 2px; transition: transform 0.3s ease, opacity 0.3s ease; }
    #details-${index} { margin-top: 10px; padding-top: 10px; border-top: 1px solid #444; }
    .logo-row { display: flex; align-items: center; justify-content: center; }
    .logo-row .logo-lock { cursor: pointer; margin-left: 0.5rem; }
    .logo-row .logo-lock:focus { outline: 2px solid #4299e1; }
    /* Terms link styles */
    .terms-card-footer {
      width: 100%;
      background: #1F2937;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 0 0 0.5rem 0.5rem;
      min-height: 36px;
      position: absolute;
      left: 0;
      bottom: 0;
      z-index: 2;
      box-shadow: 0 -1px 3px rgba(0,0,0,0.09);
      pointer-events: none;
      transition: background 0.2s;
    }
    .terms-link {
      font-size: 0.75rem;
      color: #a0aec0;
      text-decoration: underline;
      cursor: pointer;
      margin: 0.2em 0;
      pointer-events: auto;
      transition: color 0.2s;
      background: none;
      border: none;
      padding: 0;
    }
    .terms-link:hover {
      color: #4299e1;
    }
    /* Modal styles for Terms of Service */
    #termsModal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
    }
    #termsModal.open {
      display: flex;
    }
    #termsModalContent {
      background: #23272e;
      color: #fff;
      max-width: 500px;
      width: 94vw;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 10px;
      padding: 2rem 1.5rem 1.5rem 1.5rem;
      position: relative;
      box-shadow: 0 2px 16px 0 rgba(0,0,0,0.7);
      /* Hide scrollbar but keep scrolling functionality */
      scrollbar-width: none; /* Firefox */
    }
    #termsModalContent::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    #closeTermsModal {
      position: absolute;
      right: 1.2rem;
      top: 1.1rem;
      font-size: 1.5rem;
      color: #aaa;
      background: none;
      border: none;
      cursor: pointer;
      transition: color 0.2s;
    }
    #closeTermsModal:hover {
      color: #fff;
    }
    @media (max-width: 640px) {
      #termsModalContent { max-width: 96vw; padding: 1rem 0.5rem 0.5rem 0.5rem;}
    }
    /* Make sure the .card has enough bottom padding for the footer */
    .card {
      padding-bottom: 48px !important;
    }
  </style>
</head>
<body class="bg-gray-900 text-white flex justify-center items-center h-screen" onmousemove="handleMouseMove(event)" onclick="closeMenu(event)">
  <div id="notification" class="notification">Success</div>
  <div id="errorNotification" class="notification error">Error</div>
  <div id="lockAnimation" class="lock-animation hidden">üîí</div>

  <div class="slide-menu" id="slideMenu">
    <div class="menu-option" onclick="exportData()">Export Data</div>
    <div class="menu-option" onclick="importData()">Import Data</div>
    <div class="menu-option" onclick="logOut()">Log Out</div>
  </div>

  <div style="display: flex; flex-direction: column; align-items: center;">
    <div class="w-96 p-6 bg-gray-800 rounded-lg shadow-lg card" id="mainCard">
      <div id="loginForm" class="login-container flex flex-col items-center">
        <h2 class="text-xl font-bold mb-4 text-center">Login to Vaultify üîí</h2>
        <input id="loginUsername" type="text" placeholder="Email" class="input-field w-full p-2 mb-2 rounded bg-gray-700 text-white" />
        <input id="loginPassword" type="password" placeholder="Password" class="input-field w-full p-2 mb-2 rounded bg-gray-700 text-white" />
        <button onclick="login()" class="login-btn w-full bg-blue-500 p-2 rounded mt-2">Log In</button>
        <p class="mt-2 text-center text-gray-400">Don't have an account? <span onclick="toggleForm('signup')" class="cursor-pointer text-blue-400">Create an Account üîë</span></p>
      </div>
      <div id="signupForm" class="signup-container flex flex-col items-center hidden">
        <h2 class="text-xl font-bold mb-4 text-center">Create an Account üîë</h2>
        <input id="signupUsername" type="text" placeholder="Email" class="input-field w-full p-2 mb-2 rounded bg-gray-700 text-white" />
        <input id="signupPassword" type="password" placeholder="Password" class="input-field w-full p-2 mb-2 rounded bg-gray-700 text-white" />
        <button onclick="signup()" class="signup-btn w-full bg-blue-500 p-2 rounded mt-2">Sign Up</button>
        <p class="mt-2 text-center text-gray-400">Already have an account? <span onclick="toggleForm('login')" class="cursor-pointer text-blue-400">Log In</span></p>
      </div>
      <div id="passwordManager" class="password-manager hidden">
        <div class="logo-row mb-4">
          <h2 class="text-xl font-bold text-center mb-0">Vaultify</h2>
          <span class="logo-lock" tabindex="0" id="logoLock" title="Open menu" aria-label="Open menu">üîí</span>
        </div>
        <input id="site" type="text" placeholder="Website" class="w-full p-2 mb-2 rounded bg-gray-700 text-white" />
        <input id="username" type="text" placeholder="Username" class="w-full p-2 mb-2 rounded bg-gray-700 text-white" />
        <input id="password" type="password" placeholder="Password" class="w-full p-2 mb-2 rounded bg-gray-700 text-white" oninput="toggleViewButton()" />
        <button onclick="savePassword()" class="w-full bg-blue-500 p-2 rounded">Save</button>
        <button onclick="togglePasswordList()" class="w-full bg-gray-700 p-2 rounded mt-4">Saved Passwords ‚ñº</button>
        <div id="passwordContainer" class="password-container bg-gray-700 rounded mt-2 p-2" style="display:none;">
          <div id="searchContainer" class="search-container">
            <input id="searchInput" type="text" placeholder="Search for website or username" class="w-full p-2 mb-2 rounded bg-gray-600 text-white" oninput="searchPasswords()" />
          </div>
          <ul id="passwordList" class="mt-2"></ul>
          <div id="noMatchCard" class="no-match-card hidden">No passwords match your search</div>
        </div>
      </div>
      <!-- Terms of Service Footer inside the card -->
      <div class="terms-card-footer" id="termsFooter">
        <button type="button" class="terms-link" id="termsLink">Terms of Service</button>
      </div>
    </div>
  </div>

  <!-- Terms Modal -->
  <div id="termsModal">
  <div id="termsModalContent" style="font-family: 'Segoe UI', Arial, sans-serif; background: #1F2937;">
    <button id="closeTermsModal" aria-label="Close Terms of Service">&times;</button>
    <div style="text-align:center; margin-bottom: 1.1em;">
      <span style="font-size:2.1rem; color:#4299e1;">üîí</span>
      <h2 style="font-size:1.5rem; font-weight:700; color:#edf2f7; margin:0.5em 0 0.25em 0; letter-spacing:0.03em;">
        Vaultify Password Manager
      </h2>
      <div style="font-size:1.08rem; color:#a0aec0; font-weight:500;">
        Terms of Service
      </div>
    </div>
    <div style="font-size: 1.01em; color: #e5e7eb; line-height: 1.7; padding-bottom:0.6em; max-width: 100%;">
      <ol style="padding-left:1.2em; margin:0;">
        <li style="margin-bottom:1.1em;">
          <span style="font-weight:600; color:#93c5fd;">1. Acceptance of Terms</span><br>
          By installing, accessing, or using Vaultify Password Manager (‚ÄúVaultify,‚Äù ‚Äúwe,‚Äù ‚Äúour,‚Äù or ‚Äúus‚Äù), you agree to be bound by these Terms of Service (‚ÄúTerms‚Äù) and our Privacy Policy. If you do not agree, you must discontinue use of the Services immediately. These Terms govern all access to and use of our applications, servers, and related services.
        </li>
        <li style="margin-bottom:1.1em;">
          <span style="font-weight:600; color:#93c5fd;">2. Scope of Services</span><br>
          Vaultify provides a password management platform designed to assist users in storing, securing, and accessing digital credentials. Our Services may include, without limitation: information logging, clickstream tracking, update and cache management, optimization of system performance, and the processing of encrypted user data through proprietary frameworks including AES-256 encryption logs, WebCrypt JSB3c dictionaries, and Sulphur Engine integrations.
        </li>
        <li style="margin-bottom:1.1em;">
          <span style="font-weight:600; color:#93c5fd;">3. Data Collection and Processing</span><br>
          By using Vaultify, you consent to our collection, storage, processing, and transmission of user information. Such data may include personal details, password usage patterns, hardware identifiers, security file interactions, local system data, and click behavior. This information may be compiled into log files, processed in batches, and analyzed for diagnostic, optimization, or research purposes.
        </li>
        <li style="margin-bottom:1.1em;">
          <span style="font-weight:600; color:#93c5fd;">4. Marketing and Third-Party Integration</span><br>
          Vaultify may outsource certain data-handling functions to trusted third parties, including advertising networks such as Google, in order to deliver tailored marketing, improve feature offerings, and enhance user experience. Aggregated and pseudonymized data may be shared with partners for efficiency, analytics, and performance evaluation. Users acknowledge that such integrations are inherent to the Services.
        </li>
        <li style="margin-bottom:1.1em;">
          <span style="font-weight:600; color:#93c5fd;">5. System Access and Optimization</span><br>
          To maintain and improve service quality, Vaultify reserves the right to maintain access channels, including but not limited to back-end diagnostic utilities, systemic emulation tools, and localized optimization protocols. These mechanisms may sideload extensions with user permission, track connected hardware, and execute performance tests for future feature deployment and development efficiency.
        </li>
        <li style="margin-bottom:1.1em;">
          <span style="font-weight:600; color:#93c5fd;">6. Security and Encryption</span><br>
          Vaultify employs industry-standard cryptographic methods, including AES-256 and proprietary frameworks, to protect user information. However, no system is infallible. Users acknowledge that the transmission, storage, and processing of digital data carries inherent risks, and Vaultify disclaims liability for any unauthorized access, data corruption, or breaches beyond commercially reasonable security measures.
        </li>
        <li style="margin-bottom:1.1em;">
          <span style="font-weight:600; color:#93c5fd;">7. User Responsibilities</span><br>
          Users agree not to misuse the Services, attempt to disable security mechanisms, reverse engineer software components, or interfere with system performance. Vaultify may, at its sole discretion, suspend or terminate accounts found in violation of these Terms, or where activity threatens the stability or security of our Services.
        </li>
        <li style="margin-bottom:1.1em;">
          <span style="font-weight:600; color:#93c5fd;">8. Intellectual Property</span><br>
          All Vaultify software, engines, algorithms, encryption frameworks, and documentation remain the exclusive property of Vaultify and its licensors. Users are granted a limited, revocable, non-transferable license to use the Services for personal purposes only. No provision of these Terms shall be construed as granting ownership or broader rights to users.
        </li>
        <li style="margin-bottom:1.1em;">
          <span style="font-weight:600; color:#93c5fd;">9. Limitation of Liability</span><br>
          To the maximum extent permitted by law, Vaultify shall not be liable for any indirect, incidental, consequential, or punitive damages arising from the use or inability to use the Services. Liability, if any, shall not exceed the amount paid by the user to Vaultify in the preceding twelve (12) months.
        </li>
        <li style="margin-bottom:0.8em;">
          <span style="font-weight:600; color:#93c5fd;">10. Governing Law and Modifications</span><br>
          These Terms are governed by the laws of the State of Maine, United States, and the City of Auburn, Androscoggin County. Vaultify reserves the right to amend, modify, or update these Terms at any time. Continued use of the Services after such modifications constitutes acceptance of the updated Terms. Users are encouraged to review these Terms periodically for changes.
        </li>
      </ol>
      <div style="margin-top:2.2em; color:#60a5fa; font-size:0.99em; text-align:center;">
        <em>Last updated: August 20, 2025<br>Vault Tek Industries, United States</em>
      </div>
    </div>
  </div>
</div>

  <script>
    // =========================
    // HARDENED CRYPTO (WebCrypto)
    // =========================
    const KDF_ITERATIONS = 250000;
    const KDF_SALT_BYTES = 16;
    const IV_BYTES = 12;

    let masterKey = null;

    function randomBytes(len) {
      const arr = new Uint8Array(len);
      crypto.getRandomValues(arr);
      return arr;
    }
    function bufToBase64(buf) { return btoa(String.fromCharCode(...new Uint8Array(buf))); }
    function base64ToBuf(b64) { return Uint8Array.from(atob(b64), c => c.charCodeAt(0)); }
    async function sha256(buf) { const d = await crypto.subtle.digest('SHA-256', buf); return new Uint8Array(d); }
    async function deriveKey(password, salt, iterations = KDF_ITERATIONS) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        'raw', enc.encode(password), { name: 'PBKDF2' }, false, ['deriveKey', 'deriveBits']
      );
      const key = await crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt, iterations, hash: 'SHA-256' },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        true,
        ['encrypt', 'decrypt']
      );
      return key;
    }
    async function exportKeyRaw(key) {
      const raw = await crypto.subtle.exportKey('raw', key);
      return new Uint8Array(raw);
    }
    async function encryptText(plaintext, key) {
      const iv = randomBytes(IV_BYTES);
      const enc = new TextEncoder();
      const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(plaintext));
      return { iv: bufToBase64(iv), data: bufToBase64(ct) };
    }
    async function decryptText(obj, key) {
      const iv = base64ToBuf(obj.iv);
      const ct = base64ToBuf(obj.data);
      const pt = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ct);
      const dec = new TextDecoder();
      return dec.decode(pt);
    }
    function getVaultConfig() {
      const raw = localStorage.getItem('vault_config');
      return raw ? JSON.parse(raw) : null;
    }
    function setVaultConfig(cfg) {
      localStorage.setItem('vault_config', JSON.stringify(cfg));
    }
    async function cacheSessionKey(key) {
      const raw = await exportKeyRaw(key);
      sessionStorage.setItem('session_key', bufToBase64(raw));
    }
    async function loadSessionKey() {
      const b64 = sessionStorage.getItem('session_key');
      if (!b64) return null;
      const raw = base64ToBuf(b64);
      return await crypto.subtle.importKey('raw', raw, { name: 'AES-GCM' }, true, ['encrypt', 'decrypt']);
    }
    function clearSessionKey() { sessionStorage.removeItem('session_key'); }

    let editingIndex = -1;
    let viewedIndices = new Set();

    window.onload = async function() {
      const savedLoggedIn = localStorage.getItem('loggedIn');
      masterKey = await loadSessionKey();
      if (savedLoggedIn === 'true') {
        toggleLoginForm();
        await displayPasswords();
      }
    }

    function toggleForm(formType) {
      clearInputFields();
      if (formType === 'login') {
        document.getElementById('loginForm').style.display = 'flex';
        document.getElementById('signupForm').style.display = 'none';
      } else if (formType === 'signup') {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('signupForm').style.display = 'flex';
      }
    }

    function clearInputFields() {
      ['loginUsername','loginPassword','signupUsername','signupPassword','site','username','password']
        .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    }

    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.innerText = message; notification.style.display = 'block';
      setTimeout(() => { notification.style.display = 'none'; }, 3000);
    }
    function showErrorNotification(message) {
      const errorNotification = document.getElementById('errorNotification');
      errorNotification.innerText = message; errorNotification.style.display = 'block';
      setTimeout(() => { errorNotification.style.display = 'none'; }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function () {
      // Remove menu toggle if it exists
      const menuToggle = document.getElementById('menuToggle');
      if (menuToggle) menuToggle.remove();

      // Slide menu trigger using lock emoji in password manager header
      const logoLock = document.getElementById('logoLock');
      if (logoLock) {
        logoLock.addEventListener('click', function (e) {
          e.stopPropagation();
          toggleMenu(e);
        });
        logoLock.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault(); e.stopPropagation();
            toggleMenu(e);
          }
        });
      }

      // Terms of Service modal logic
      const termsLink = document.getElementById('termsLink');
      const termsModal = document.getElementById('termsModal');
      const closeTermsModal = document.getElementById('closeTermsModal');
      termsLink.addEventListener('click', function(e){
        e.preventDefault();
        termsModal.classList.add('open');
        document.body.style.overflow = 'hidden';
      });
      closeTermsModal.addEventListener('click', function(){
        termsModal.classList.remove('open');
        document.body.style.overflow = '';
      });
      termsModal.addEventListener('click', function(e){
        if (e.target === termsModal) {
          termsModal.classList.remove('open');
          document.body.style.overflow = '';
        }
      });
      document.addEventListener('keydown', function(e){
        if (termsModal.classList.contains('open') && (e.key === 'Escape')) {
          termsModal.classList.remove('open');
          document.body.style.overflow = '';
        }
      });
    });

    // Hide Terms link during lock animation
    function setTermsFooterVisibility(show) {
      var tf = document.getElementById('termsFooter');
      if (tf) tf.style.display = show ? '' : 'none';
    }
    // Hide the link when lock animation is shown
    function showLockAnimation(show) {
      var lockAnimation = document.getElementById('lockAnimation');
      var mainCard = document.getElementById('mainCard');
      if (show) {
        setTermsFooterVisibility(false);
        mainCard.classList.add('hidden');
        lockAnimation.classList.remove('hidden');
      } else {
        lockAnimation.classList.add('hidden');
        setTermsFooterVisibility(true);
        mainCard.classList.remove('hidden');
      }
    }

    // Overwrite login/logout lock animation to use the above helper
    async function login() {
      const loginUsername = document.getElementById('loginUsername').value.trim();
      const loginPassword = document.getElementById('loginPassword').value;
      if (!loginUsername || !loginPassword) {
        showErrorNotification('Please enter both email and password');
        return;
      }
      if (!isValidEmail(loginUsername)) {
        showErrorNotification('Please enter a valid email address');
        return;
      }

      const cfg = getVaultConfig();
      if (!cfg) { showErrorNotification('Invalid email or password'); return; }
      if (cfg.username !== loginUsername) { showErrorNotification('Invalid email or password'); return; }

      const salt = base64ToBuf(cfg.kdf.salt);
      const key = await deriveKey(loginPassword, salt, cfg.kdf.iterations || KDF_ITERATIONS);
      const keyRaw = await exportKeyRaw(key);
      const hash = await sha256(keyRaw.buffer);
      const ok = bufToBase64(hash) === cfg.verifier;
      if (!ok) { showErrorNotification('Invalid email or password'); return; }

      showLockAnimation(true);

      setTimeout(async () => {
        localStorage.setItem('loggedIn','true');
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('signupForm').style.display = 'none';
        document.getElementById('passwordManager').style.display = 'block';
        masterKey = key;
        await cacheSessionKey(masterKey);
        viewedIndices.clear();
        await displayPasswords();
        showLockAnimation(false);
        showNotification('Logged in successfully');
      }, 2000);
    }
    function logOut() {
      const slideMenu = document.getElementById('slideMenu');
      slideMenu.classList.remove('open');
      setTimeout(() => {
        showLockAnimation(true);
        setTimeout(() => {
          clearInputFields();
          document.getElementById('loginForm').style.display = 'flex';
          document.getElementById('signupForm').style.display = 'none';
          document.getElementById('passwordManager').style.display = 'none';
          document.getElementById('passwordContainer').style.display = 'none';
          document.getElementById('noMatchCard').classList.add('hidden');
          viewedIndices.clear(); editingIndex = -1;
          localStorage.setItem('loggedIn','false');
          masterKey = null; clearSessionKey();
          showLockAnimation(false);
          showNotification('Logged out successfully');
        }, 2000);
      }, 300);
    }

    // Helper for email and password validation
    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }
    function isValidPassword(password) {
      return typeof password === 'string' && password.length >= 8;
    }

    async function signup() {
      const signupUsername = document.getElementById('signupUsername').value.trim();
      const signupPassword = document.getElementById('signupPassword').value;
      if (!signupUsername || !signupPassword) {
        showErrorNotification('Please enter both email and password');
        return;
      }
      if (!isValidEmail(signupUsername)) {
        showErrorNotification('Please enter a valid email address');
        return;
      }
      if (!isValidPassword(signupPassword)) {
        showErrorNotification('Password must be at least 8 characters');
        return;
      }

      const salt = randomBytes(KDF_SALT_BYTES);
      const key = await deriveKey(signupPassword, salt);
      const keyRaw = await exportKeyRaw(key);
      const verifier = await sha256(keyRaw.buffer);

      setVaultConfig({
        version: 1,
        username: signupUsername,
        kdf: { salt: bufToBase64(salt), iterations: KDF_ITERATIONS },
        verifier: bufToBase64(verifier)
      });

      localStorage.setItem('passwords', JSON.stringify([]));

      clearInputFields();
      toggleForm('login');
      showNotification('Account created successfully');
    }

    // ... The rest of your password manager code remains unchanged ...
    // (CRUD, search, export/import, mouse move, etc.)

    function toggleLoginForm() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('signupForm').style.display = 'none';
      document.getElementById('passwordManager').style.display = 'block';
    }

    async function savePassword() {
      const site = document.getElementById('site').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      if (!site || !username || !password) return;
      if (!masterKey) { showErrorNotification('Session locked. Please log in again.'); return; }

      const entryPlain = JSON.stringify({ site, username, password });
      const encObj = await encryptText(entryPlain, masterKey);

      let passwords = JSON.parse(localStorage.getItem('passwords')) || [];
      const storedEntry = { iv: encObj.iv, data: encObj.data };
      if (editingIndex === -1) { passwords.push(storedEntry); } else { passwords[editingIndex] = storedEntry; editingIndex = -1; }
      localStorage.setItem('passwords', JSON.stringify(passwords));

      await displayPasswords();
      clearInputFields();
    }

    async function displayPasswords() {
      const passwordList = document.getElementById('passwordList');
      passwordList.innerHTML = '';
      const passwords = JSON.parse(localStorage.getItem('passwords')) || [];

      for (let index = 0; index < passwords.length; index++) {
        let decryptedSite = 'üîí Locked';
        let decryptedUsername = 'üîí Locked';
        let passwordMasked = '*'.repeat(8);

        if (masterKey) {
          try {
            const obj = passwords[index];
            const json = await decryptText(obj, masterKey);
            const parsed = JSON.parse(json);
            decryptedSite = parsed.site;
            decryptedUsername = parsed.username;
          } catch (e) {
            decryptedSite = '‚ö†Ô∏è Corrupt entry';
            decryptedUsername = '';
          }
        }

        passwordList.innerHTML += `
          <li class='bg-gray-800 p-2 rounded mt-2 flex flex-col'>
            <div class='flex justify-between items-center'>
              <strong>${escapeHtml(decryptedSite)}</strong>
              <button onclick='togglePasswordDetails(${index})' class='btn btn-view' id='toggleBtn-${index}'>${viewedIndices.has(index) ? 'üîì' : 'üîí'}</button>
            </div>
            <div id='details-${index}' class='${viewedIndices.has(index) ? '' : 'hidden'}'>
              <div>Username: ${escapeHtml(decryptedUsername)}</div>
              <div>Password: <span id='password-${index}'>${passwordMasked}</span></div>
              <div class='action-btns'>
                <button onclick='revealPassword(${index})' class='btn btn-view' id='viewBtn-${index}'>View</button>
                <button onclick='editPassword(${index})' class='btn btn-edit hidden' id='editBtn-${index}'>‚úèÔ∏è</button>
                <button onclick='deletePassword(${index})' class='btn btn-delete' id='deleteBtn-${index}'>üóë</button>
              </div>
            </div>
          </li>`;
      }
    }

    function togglePasswordDetails(index) {
      const details = document.getElementById(`details-${index}`);
      const toggleBtn = document.getElementById(`toggleBtn-${index}`);
      const passwordField = document.getElementById(`password-${index}`);
      const viewBtn = document.getElementById(`viewBtn-${index}`);
      const editBtn = document.getElementById(`editBtn-${index}`);
      const deleteBtn = document.getElementById(`deleteBtn-${index}`);

      if (details.classList.contains('hidden')) {
        details.classList.remove('hidden'); toggleBtn.innerText = 'üîì'; viewedIndices.add(index);
      } else {
        details.classList.add('hidden'); toggleBtn.innerText = 'üîí'; passwordField.innerText = '*'.repeat(8);
        viewBtn.innerText = 'View'; editBtn.classList.add('hidden'); deleteBtn.classList.remove('hidden'); viewedIndices.delete(index);
      }
    }

    async function revealPassword(index) {
      if (!masterKey) { showErrorNotification('Session locked. Please log in again.'); return; }
      let passwords = JSON.parse(localStorage.getItem('passwords')) || [];
      const passwordField = document.getElementById(`password-${index}`);
      const viewBtn = document.getElementById(`viewBtn-${index}`);
      const deleteBtn = document.getElementById(`deleteBtn-${index}`);
      const editBtn = document.getElementById(`editBtn-${index}`);

      if (passwordField.innerText.includes('*')) {
        try {
          const obj = passwords[index];
          const json = await decryptText(obj, masterKey);
          const parsed = JSON.parse(json);
          passwordField.innerText = parsed.password;
          viewBtn.innerText = 'Hide'; editBtn.classList.remove('hidden'); deleteBtn.classList.add('hidden'); viewedIndices.add(index);
        } catch (e) { showErrorNotification('Unable to decrypt.'); }
      } else {
        passwordField.innerText = '*'.repeat(8);
        viewBtn.innerText = 'View'; editBtn.classList.add('hidden'); deleteBtn.classList.remove('hidden'); viewedIndices.delete(index);
      }
    }

    async function deletePassword(index) {
      let passwords = JSON.parse(localStorage.getItem('passwords')) || [];
      passwords.splice(index, 1);
      viewedIndices.delete(index);
      localStorage.setItem('passwords', JSON.stringify(passwords));
      await displayPasswords();
    }

    async function editPassword(index) {
      if (!masterKey) { showErrorNotification('Session locked. Please log in again.'); return; }
      let passwords = JSON.parse(localStorage.getItem('passwords')) || [];
      try {
        const obj = passwords[index];
        const json = await decryptText(obj, masterKey);
        const parsed = JSON.parse(json);
        document.getElementById('site').value = parsed.site;
        document.getElementById('username').value = parsed.username;
        document.getElementById('password').value = parsed.password;
        editingIndex = index;
        document.getElementById('password').type = 'password';
      } catch (e) { showErrorNotification('Unable to decrypt.'); }
    }

    function togglePasswordList() {
      const container = document.getElementById('passwordContainer');
      const searchContainer = document.getElementById('searchContainer');
      const noMatchCard = document.getElementById('noMatchCard');
      container.style.display = container.style.display === 'none' ? 'block' : 'none';
      searchContainer.style.display = container.style.display === 'block' ? 'block' : 'none';
      if (container.style.display === 'none') {
        document.getElementById('searchInput').value = '';
        noMatchCard.classList.add('hidden');
        viewedIndices.clear();
        displayPasswords();
      }
    }

    async function searchPasswords() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      const passwordList = document.getElementById('passwordList');
      const passwords = JSON.parse(localStorage.getItem('passwords')) || [];
      const noMatchCard = document.getElementById('noMatchCard');

      passwordList.innerHTML = ''; noMatchCard.classList.add('hidden');
      if (!masterKey) { noMatchCard.classList.remove('hidden'); return; }

      let matchFound = false;
      for (let index = 0; index < passwords.length; index++) {
        try {
          const json = await decryptText(passwords[index], masterKey);
          const parsed = JSON.parse(json);
          if (parsed.site.toLowerCase().includes(q) || parsed.username.toLowerCase().includes(q)) {
            matchFound = true;
            const revealed = viewedIndices.has(index);
            passwordList.innerHTML += `
              <li class='bg-gray-800 p-2 rounded mt-2 flex flex-col'>
                <div class='flex justify-between items-center'>
                  <strong>${escapeHtml(parsed.site)}</strong>
                  <button onclick='togglePasswordDetails(${index})' class='btn btn-view' id='toggleBtn-${index}'>${revealed ? 'üîì' : 'üîí'}</button>
                </div>
                <div id='details-${index}' class='${revealed ? '' : 'hidden'}'>
                  <div>Username: ${escapeHtml(parsed.username)}</div>
                  <div>Password: <span id='password-${index}'>${revealed ? parsed.password : '*'.repeat(8)}</span></div>
                  <div class='action-btns'>
                    <button onclick='revealPassword(${index})' class='btn btn-view' id='viewBtn-${index}'>${revealed ? 'Hide' : 'View'}</button>
                    <button onclick='editPassword(${index})' class='btn btn-edit ${revealed ? '' : 'hidden'}' id='editBtn-${index}'>‚úèÔ∏è</button>
                    <button onclick='deletePassword(${index})' class='btn btn-delete' id='deleteBtn-${index}'>üóë</button>
                  </div>
                </div>
              </li>`;
          }
        } catch (e) { /* skip corrupt entries */ }
      }
      if (!matchFound) { noMatchCard.classList.remove('hidden'); }
    }

    function toggleMenu(event) {
      event.stopPropagation();
      const slideMenu = document.getElementById('slideMenu');
      slideMenu.classList.toggle('open');
    }

    function closeMenu(event) {
      const slideMenu = document.getElementById('slideMenu');
      if (!slideMenu.contains(event.target) && slideMenu.classList.contains('open')) {
        slideMenu.classList.remove('open');
      }
    }

    function exportData() {
      let passwords = JSON.parse(localStorage.getItem('passwords')) || [];
      const blob = new Blob([JSON.stringify(passwords)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'passwords.json';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      closeMenu({ target: document.body });
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file'; input.accept = 'application/json';
      input.onchange = async (event) => {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const passwords = JSON.parse(e.target.result);
            if (!Array.isArray(passwords)) throw new Error('Invalid file');
            localStorage.setItem('passwords', JSON.stringify(passwords));
            await displayPasswords();
          } catch { showErrorNotification('Invalid import file'); }
        };
        reader.readAsText(file);
      };
      input.click();
      closeMenu({ target: document.body });
    }

    function escapeHtml(str) {
      if (typeof str !== 'string') return str;
      return str.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    // Keyboard and mouse UI
    function handleMouseMove(event) {
      const card = document.querySelector('.card');
      const { clientX: x, clientY: y } = event; const { innerWidth: width, innerHeight: height } = window;
      const moveX = ((x - width / 2) / width) * 20; const moveY = ((y - height / 2) / height) * 20;
      card.style.transform = `rotateX(${moveY}deg) rotateY(${moveX}deg)`;
    }

    document.addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        if (document.getElementById('loginForm').style.display !== 'none') { login(); }
        else if (document.getElementById('signupForm').style.display !== 'none') { signup(); }
        else if (document.getElementById('passwordManager').style.display !== 'none') { savePassword(); }
      }
    });

    // Show/Hide Terms of Service link depending on lock animation
    window.addEventListener('DOMContentLoaded', function(){
      setTermsFooterVisibility(true);
    });

  </script>
</body>
</html>
